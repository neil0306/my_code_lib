# Multi-RTSP YOLO Batch Processing

è¿™ä¸ªè„šæœ¬å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ª RTSP æµï¼Œä½¿ç”¨ YOLO è¿›è¡Œæ‰¹é‡æ¨ç†ï¼Œè‡ªåŠ¨å¤„ç†æµä¸­æ–­å’Œ batch size å˜åŒ–ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸ¯ **æ‰¹é‡ YOLO æ¨ç†**: å°†å¤šä¸ªæµçš„å¸§ç»„æˆ batch è¿›è¡ŒåŠ é€Ÿæ¨ç†
- ğŸ”„ **è‡ªåŠ¨é‡è¿**: è‡ªåŠ¨å¤„ç† RTSP æµä¸­æ–­å’Œé‡æ–°è¿æ¥
- ğŸ“Š **åŠ¨æ€ Batch**: æ ¹æ®å¯ç”¨æµåŠ¨æ€è°ƒæ•´ batch size
- ğŸ–¼ï¸ **ç½‘æ ¼æ˜¾ç¤º**: åœ¨ä¸€ä¸ªçª—å£ä¸­æ˜¾ç¤ºæ‰€æœ‰æµçš„æ£€æµ‹ç»“æœ
- ğŸ“ˆ **æ€§èƒ½ç»Ÿè®¡**: å®æ—¶æ˜¾ç¤º FPSã€æ‰¹é‡å¤§å°ç­‰ç»Ÿè®¡ä¿¡æ¯
- ğŸ¨ **ç»“æœæ˜ å°„**: æ­£ç¡®åœ°å°† YOLO æ£€æµ‹ç»“æœç»˜åˆ¶åˆ°å¯¹åº”çš„æµä¸Š

## ä¾èµ–å®‰è£…

```bash
# å®‰è£…åŸºæœ¬ä¾èµ–
pip install opencv-python ultralytics numpy

# å¯é€‰ï¼šå¦‚æœéœ€è¦è™šæ‹Ÿæ‘„åƒå¤´åŠŸèƒ½
pip install pyvirtualcam

# å¯é€‰ï¼šå¦‚æœéœ€è¦HTTPæµåª’ä½“åŠŸèƒ½
pip install flask
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# ä½¿ç”¨é»˜è®¤RTSP URLè¿›è¡Œæµ‹è¯•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»º4ä¸ªæµï¼‰
python multi_rtsp_yolo_batch.py

# æŒ‡å®šå•ä¸ªRTSP URL
python multi_rtsp_yolo_batch.py --rtsp-urls rtsp://your-camera-url

# æŒ‡å®šå¤šä¸ªRTSP URLs
python multi_rtsp_yolo_batch.py --rtsp-urls \
    rtsp://camera1-url \
    rtsp://camera2-url \
    rtsp://camera3-url \
    rtsp://camera4-url
```

### é«˜çº§å‚æ•°

```bash
python multi_rtsp_yolo_batch.py \
    --rtsp-urls rtsp://admin:Password01@192.168.1.65:554/Streaming/Channels/1/?transportmode=unicast \
    --model yolov8s.pt \
    --batch-size 8 \
    --width 640 \
    --height 480 \
    --confidence 0.6 \
    --grid-cols 3 \
    --no-display
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--rtsp-urls` | æµ‹è¯• URL | RTSP æµ URLs åˆ—è¡¨ |
| `--model` | yolov8n.pt | YOLO æ¨¡å‹è·¯å¾„ |
| `--batch-size` | 4 | æœ€å¤§ batch å¤§å° |
| `--width` | 640 | å¸§å®½åº¦ |
| `--height` | 480 | å¸§é«˜åº¦ |
| `--confidence` | 0.5 | ç½®ä¿¡åº¦é˜ˆå€¼ |
| `--grid-cols` | 2 | æ˜¾ç¤ºç½‘æ ¼åˆ—æ•° |
| `--no-display` | False | ç¦ç”¨æ˜¾ç¤ºçª—å£ |

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. RTSPStreamHandler - å•æµå¤„ç†å™¨

æ¯ä¸ª RTSP æµéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å¤„ç†å™¨ï¼š
- **è‡ªåŠ¨é‡è¿**: æµä¸­æ–­æ—¶è‡ªåŠ¨å°è¯•é‡è¿ï¼ˆæœ€å¤š 5 æ¬¡ï¼‰
- **å¸§é˜Ÿåˆ—**: ä½¿ç”¨é˜Ÿåˆ—ç¼“å­˜æœ€æ–°å¸§ï¼Œé¿å…å»¶è¿Ÿç´¯ç§¯
- **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§è¿æ¥çŠ¶æ€å’Œå¸§æ—¶é—´æˆ³

### 2. MultiStreamYOLOProcessor - æ‰¹é‡å¤„ç†å™¨

è´Ÿè´£åè°ƒå¤šä¸ªæµå¹¶è¿›è¡Œæ‰¹é‡æ¨ç†ï¼š
- **åŠ¨æ€ Batch**: æ”¶é›†å½“å‰å¯ç”¨çš„æ‰€æœ‰å¸§ç»„æˆ batch
- **ç»“æœæ˜ å°„**: ç¡®ä¿æ¯ä¸ªæ¨ç†ç»“æœæ­£ç¡®å¯¹åº”åˆ°åŸå§‹æµ
- **æ€§èƒ½ç»Ÿè®¡**: è·Ÿè¸ª FPSã€batch å¤§å°ç­‰å…³é”®æŒ‡æ ‡

### 3. MultiStreamDisplay - ç½‘æ ¼æ˜¾ç¤º

å°†å¤šä¸ªæµç»“æœæ˜¾ç¤ºåœ¨ç½‘æ ¼å¸ƒå±€ä¸­ï¼š
- **ç½‘æ ¼å¸ƒå±€**: è‡ªåŠ¨è®¡ç®—æœ€ä½³ç½‘æ ¼å°ºå¯¸
- **çŠ¶æ€æ˜¾ç¤º**: æ˜¾ç¤ºæµçŠ¶æ€å’Œæ£€æµ‹ç»Ÿè®¡
- **äº¤äº’æ§åˆ¶**: æ”¯æŒæŒ‰é”®ä¿å­˜æˆªå›¾å’Œé€€å‡º

## æµä¸­æ–­å¤„ç†

è„šæœ¬å…·æœ‰å¼ºå¤§çš„æµä¸­æ–­æ¢å¤èƒ½åŠ›ï¼š

1. **æ£€æµ‹ä¸­æ–­**: ç›‘æ§`cap.read()`è¿”å›çŠ¶æ€
2. **è‡ªåŠ¨é‡è¿**: æµä¸­æ–­æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æºå¹¶é‡æ–°è¿æ¥
3. **åŠ¨æ€ Batch**: batch size ä¼šæ ¹æ®æ´»è·ƒæµæ•°é‡åŠ¨æ€è°ƒæ•´
4. **çŠ¶æ€åŒæ­¥**: æ‰€æœ‰ç»„ä»¶éƒ½èƒ½æ­£ç¡®å¤„ç†æµçŠ¶æ€å˜åŒ–

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡æ¨ç†åŠ é€Ÿ

```python
# ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªæµå•ç‹¬æ¨ç†
for stream in streams:
    result = model(frame)  # 4 æ¬¡æ¨ç†è°ƒç”¨

# æ‰¹é‡æ–¹å¼ï¼šä¸€æ¬¡æ¨ç†å¤„ç†å¤šå¸§
results = model([frame1, frame2, frame3, frame4])  # 1 æ¬¡æ¨ç†è°ƒç”¨
```

### å†…å­˜ç®¡ç†

- é˜Ÿåˆ—å¤§å°é™åˆ¶é˜²æ­¢å†…å­˜æº¢å‡º
- åŠæ—¶é‡Šæ”¾ OpenCV èµ„æº
- ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„ç»“æœå­˜å‚¨

### å»¶è¿Ÿæ§åˆ¶

- è®¾ç½®`CAP_PROP_BUFFERSIZE=1`å‡å°‘ç¼“å†²
- ä¸¢å¼ƒæ—§å¸§ä¿æŒå®æ—¶æ€§
- éé˜»å¡é˜Ÿåˆ—æ“ä½œ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ— æ³•è¿æ¥ RTSP æµ**
   ```
   Stream 0: è¿æ¥å¤±è´¥ï¼Œ1/5
   ```
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯ RTSP URL æ ¼å¼
   - ç¡®è®¤ç”¨æˆ·åå’Œå¯†ç 

2. **æ˜¾ç¤ºçª—å£åˆ›å»ºå¤±è´¥**
   ```
   æ˜¾ç¤ºçª—å£åˆ›å»ºå¤±è´¥ï¼š...
   ```
   - åœ¨æœ‰ GUI çš„ç¯å¢ƒä¸­è¿è¡Œ
   - æˆ–ä½¿ç”¨`--no-display`å‚æ•°

3. **YOLO æ¨¡å‹åŠ è½½å¤±è´¥**
   ```
   åŠ è½½ YOLO æ¨¡å‹ï¼šyolov8n.pt
   ```
   - ç¡®ä¿æ¨¡å‹æ–‡ä»¶å­˜åœ¨
   - æ£€æŸ¥ ultralytics å®‰è£…

### è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
export PYTHONPATH=$PYTHONPATH:.
python multi_rtsp_yolo_batch.py --rtsp-urls your-url 2>&1 | tee debug.log
```

## æ‰©å±•åŠŸèƒ½

### æ·»åŠ æ–°çš„è¾“å‡ºæ–¹å¼

å¯ä»¥åœ¨`MultiStreamDisplay`ç±»åŸºç¡€ä¸Šæ·»åŠ ï¼š
- HTTP æµåª’ä½“è¾“å‡º
- è§†é¢‘æ–‡ä»¶ä¿å­˜
- è™šæ‹Ÿæ‘„åƒå¤´è¾“å‡º

### è‡ªå®šä¹‰æ£€æµ‹åå¤„ç†

åœ¨`process_batch`æ–¹æ³•ä¸­æ·»åŠ ï¼š
- ç›®æ ‡è·Ÿè¸ª
- åŒºåŸŸå…¥ä¾µæ£€æµ‹  
- æŠ¥è­¦æœºåˆ¶

## ç¤ºä¾‹è¾“å‡º

```
2024-01-15 10:30:15,123 - __main__ - INFO - æ·»åŠ æµ 0: rtsp://admin:Password01@192.168.1.65:554/Streaming/Channels/1/?transportmode=unicast
2024-01-15 10:30:15,124 - __main__ - INFO - ä½¿ç”¨å•ä¸ªRTSP URLåˆ›å»ºå¤šä¸ªæµ‹è¯•æµ
2024-01-15 10:30:15,124 - __main__ - INFO - æ·»åŠ æµ 1: rtsp://admin:Password01@192.168.1.65:554/Streaming/Channels/1/?transportmode=unicast
2024-01-15 10:30:15,124 - __main__ - INFO - æ·»åŠ æµ 2: rtsp://admin:Password01@192.168.1.65:554/Streaming/Channels/1/?transportmode=unicast
2024-01-15 10:30:15,125 - __main__ - INFO - æ·»åŠ æµ 3: rtsp://admin:Password01@192.168.1.65:554/Streaming/Channels/1/?transportmode=unicast
2024-01-15 10:30:15,125 - __main__ - INFO - å¯åŠ¨æ‰€æœ‰RTSPæµ...
2024-01-15 10:30:17,234 - __main__ - INFO - æ´»è·ƒæµæ•°é‡: 4/4
2024-01-15 10:30:17,235 - __main__ - INFO - å¯åŠ¨å¤šæµæ˜¾ç¤ºçª—å£ (æŒ‰ 'q' é€€å‡º, 's' ä¿å­˜æˆªå›¾)
2024-01-15 10:30:17,456 - __main__ - INFO - å¼€å§‹YOLOæ‰¹é‡å¤„ç†...
```

## é”®ç›˜æ§åˆ¶

åœ¨æ˜¾ç¤ºçª—å£ä¸­ï¼š
- `q`: é€€å‡ºç¨‹åº
- `s`: ä¿å­˜å½“å‰æˆªå›¾

## æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œå¸¦å®½**: å¤šä¸ªé«˜åˆ†è¾¨ç‡æµéœ€è¦è¶³å¤Ÿçš„ç½‘ç»œå¸¦å®½
2. **è®¡ç®—èµ„æº**: æ‰¹é‡æ¨ç†éœ€è¦è¶³å¤Ÿçš„ GPU/CPU èµ„æº
3. **åŒæ­¥é—®é¢˜**: ä¸åŒæµçš„å¸§ç‡å¯èƒ½ä¸åŒï¼Œä¼šå½±å“ batch ç»„æˆ
4. **å†…å­˜ä½¿ç”¨**: ç›‘æ§å†…å­˜ä½¿ç”¨ï¼Œé¿å…ç³»ç»Ÿè´Ÿè½½è¿‡é«˜